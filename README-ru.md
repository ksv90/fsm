# Finite State Machine (FSM)

Библиотека для создания конечных автоматов (FSM) с поддержкой событийной модели. Этот инструмент позволяет управлять состояниями и обработкой событий в приложении, обеспечивая гибкость и простоту настройки переходов и действий при изменении состояний.

## Оглавление
1. [Установка](#установка)
2. [Быстрый старт](#быстрый-старт)
3. [Подробное описание функционала](#подробное-описание-функционала)
   - [Состояния и переходы](#состояния-и-переходы)
   - [Transition Object](#transition-object)
   - [Контекст FSM](#контекст-fsm)
   - [Actions](#actions)
   - [Job](#job)
   - [Emit Object](#emit-object)
   - [Поддержка событий через EventEmitter](#поддержка-событий-fsm-через-eventemitter)
4. [Настройка и опции](#настройка-и-опции)
5. [Обработка ошибок](#обработка-ошибок)
6. [Лицензия](#лицензия)
7. [Благодарности и вдохновение](#благодарности-и-вдохновение)
8. [Контрибьюция](#контрибьюция)
9. [Примеры использования](#примеры-использования)


## Установка

Для установки библиотеки используйте предпочтительный менеджер пакетов:

```bash
npm install @ksv90/fsm
```

Эта команда добавит библиотеку в зависимости вашего проекта, после чего вы сможете использовать FSM в своем коде.

## Быстрый старт

Ниже приведен пример быстрого использования конечного автомата (FSM). Этот пример покажет, как создать простой FSM, добавить слушателей событий и управлять переходами между состояниями.

```ts
import { FiniteStateMachine } from './fsm';

// Создание новой FSM с начальными состояниями
const fsm = new FiniteStateMachine({
  initState: 'idle',
  context: {},
  states: {
    idle: {
      on: { START: [{ target: 'running' }] },
    },
    running: {
      on: { STOP: [{ target: 'idle' }] },
    },
  },
});

// Подписка на события FSM с помощью EventEmitter
fsm.on('transition', ({ stateName, nextStateName }) => {
  console.log(`Переход: ${stateName} -> ${nextStateName}`);
});

// Запуск FSM и переходы между состояниями
fsm.start(); // Переход в состояние 'idle'
fsm.send('START'); // Переход в состояние 'running'
fsm.send('STOP'); // Переход в состояние 'idle'
```

Этот пример демонстрирует простоту создания конечного автомата, его запуск, добавление слушателей и управление состояниями с использованием событийной модели.

## Подробное описание функционала

### Состояния и переходы

Finite State Machine (FSM) управляет переходами между состояниями на основе событий. Каждое состояние определяет переходы на другие состояния в ответ на определенные события.

Пример структуры состояний:

```ts
const fsm = new FiniteStateMachine({
  initState: 'idle',
  context: { count: 0 },
  states: {
    idle: {
      entry: [(context) => (context.count += 1)],
      job: async () => {
        console.log('Асинхронная задача');
        await new Promise((resolve) => setTimeout(resolve, 100));
      },
      exit: [(context) => (context.count -= 1)],
      on: {
        START: [
          { target: 'running', cond: (context) => context.count > 0, actions: [(context) => (context.count *= 2)] },
        ],
      },
    },
    running: {
      on: { STOP: [{ target: 'idle' }] },
    },
  },
});
```

- initState: Начальное состояние FSM. В данном примере — idle.
- states: Объект, содержащий определения состояний и возможных переходов.

### Внешние переходы между состояниями
FSM реагирует на события, которые инициируют переходы между состояниями. События отправляются с помощью метода ```send```.

Пример использования событий:

```ts
fsm.send('START'); // Переход из состояния 'idle' в 'running'
fsm.send('STOP');  // Переход из состояния 'running' в 'idle'
```

- ```send(eventType)```: Отправляет событие в FSM, инициируя соответствующий переход, если такой переход существует для текущего состояния.

### Transition Object

Transition Object описывает возможные переходы между состояниями и действия, которые выполняются в процессе этих переходов. Каждый переход может включать следующие свойства:

- target: Состояние, в которое будет произведен переход.
- actions: Действия, которые выполняются во время перехода.
- cond: Условие, определяющее, должен ли переход быть выполнен.

```ts
idle: {
  on: { 
    START: [{ target: 'running', cond: (context) => context.count > 0, actions: [(context) => (context.count *= 2)] }] 
  },
}
```

### Контекст FSM

Контекст (context) используется для хранения данных между переходами состояний. Он доступен внутри всех действий и условий.

```ts
context: { count: 0 }
```

### Actions

FSM поддерживает несколько типов действий:

- entry: Выполняются при входе в состояние.
- exit: Выполняются при выходе из состояния.
- actions: Выполняются в процессе перехода из одного состояния в другое.

```ts
idle: {
  entry: [(context) => (context.count += 1)],
  exit: [(context) => (context.count -= 1)],
}
```

### Job

job — это асинхронная или синхронная задача, которая выполняется при входе в состояние после действий entry.

```ts
idle: {
  job: async () => {
    await new Promise((resolve) => setTimeout(resolve, 100));
  },
}
```

```ts
idle: {
  job: (_ctx, complete) => {
    setTimeout(complete, 200);
  },
}
```

Если не указан второй аргумент *complete* функция завершается после выполнения всех инструкций.

### Emit Object

emit используется для автоматического запуска событий после завершения действий и задач состояния.

```ts
idle: {
  emit: [
    { eventType: 'START', cond: (context) => context.count > 10 },
  ],
}
```

### Поддержка событий FSM через EventEmitter

FSM использует EventEmitter для обработки событий, таких как начало и завершение переходов, вход в состояние и выход из него.

```ts
fsm.on('entry', (context) => {
  console.log(`Вход в состояние с контекстом:`, context);
});
```

Доступные события: 

- ```start```: Запуск FSM.
- ```entry```: Вход в состояние.
- ```job```: Выполнение задачи в состоянии.
- ```pending```: Ожидание перехода в другое состояние (бездействие).
- ```transition```: Переход между состояниями.
- ```exit```: Выход из состояния.
- ```finish```: Завершение процесса FSM.
- ```stop```: Остановка FSM.

Каждое из этих событий передаёт определённые данные в обработчик, что позволяет гибко реагировать на изменения в состоянии машины.

### Настройка и опции

Finite State Machine (FSM) поддерживает различные параметры конфигурации, которые позволяют настраивать поведение конечного автомата и обработку ошибок. Эти параметры определяются с использованием типов OptionsFSM и CustomErrorMessagesFSM.

Параметры OptionsFSM

```ts
export type OptionsFSM = {
  timeForWork?: number;
  errorMessages?: {
    getAlreadyStartedMessage?: () => string;
    getRestartNotAllowedMessage?: () => string;
    getCannotSendIfNotStartedMessage?: () => string;
    getCannotSendWhenStoppedMessage?: () => string;
    getUnsupportedTransitionsMessage?: (stateName: string) => string;
    getInvalidEventTypeMessage?: (stateName: string, eventType: string) => string;
    getNoTransitionObjectMessage?: (stateName: string, eventType: string) => string;
    getActionTimeLimitExceededMessage?: (stateName: string, errorDelay: number) => string;
};
```

- timeForWork: Время в миллисекундах, отведенное на выполнение задач в состоянии перед тем, как будет превышено время ожидания. Если задача не завершится за отведенное время, будет вызвано сообщение об ошибке. Использование: Этот параметр полезен для ограничения времени выполнения асинхронных задач в состоянии и предотвращения потенциальной утечки памяти.

```ts
const options: OptionsFSM = {
  timeForWork: 5000, // 5 секунд на выполнение задачи
};
```

- errorMessages: Объект, содержащий настраиваемые сообщения об ошибках для различных ситуаций, которые могут возникнуть во время работы FSM. Позволяет настраивать текст сообщений об ошибках, чтобы сделать их более информативными и понятными для пользователя.
```ts
const options: OptionsFSM = {
  errorMessages: {
    getAlreadyStartedMessage: () => 'FSM уже запущен и не может быть запущен снова.',
  },
};
```

## Обработка ошибок

FSM использует механизмы обработки исключений для управления непредвиденными ситуациями, гарантируя бесперебойную работу приложения.

Пример использования обработки ошибок с использованием события error:

```ts
fsm.on('error', (error) => {
  console.error('Произошла ошибка в FSM:', error.message);
  // Логика обработки ошибок
});
```

## Лицензия

Эта библиотека распространяется под лицензией MIT, что означает, что её могут использовать все без исключения. Лицензия MIT предоставляет пользователям следующие права:

Свобода использования: Вы можете использовать библиотеку в любых целях, включая коммерческие и некоммерческие проекты.
Свобода распространения: Вы можете свободно копировать, изменять и распространять библиотеку или её производные работы.
Простота интеграции: Лицензия позволяет интегрировать библиотеку в другие проекты без необходимости раскрытия исходного кода вашего проекта.

## Благодарности и вдохновение

Разработка этой библиотеки была вдохновлена пакетом [@xstate/fsm](https://github.com/statelyai/xstate/tree/xstate%404.38.3/packages/xstate-fsm). Я благодарен разработчикам @xstate/fsm за их вклад в сообщество и создание мощного инструмента для управления конечными автоматами. Их подход к созданию простого, но гибкого конечного автомата лег в основу данной библиотеки.

Я использовал идеи и концепции из *@xstate/fsm*, чтобы создать собственное решение, адаптированное под мои нужды, и добавил возможности, которые, на мой взгляд, делают конечные автоматы еще более удобными и мощными для использования в реальных проектах.


## Контрибьюция

Любой желающий может внести свой вклад в разработку данной библиотеки.

## Примеры использования

